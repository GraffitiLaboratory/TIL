ptmalloc 의 구현 목표는 메모리의 효율적인 관리이다.

#### 메모리 낭비 방지

ptmalloc은 메모리 할당 요청이 발생하면, 먼저 해제된 메모리 공간 중에서 재사용할 수 있는 공간이 있는지 탐색한다.
해제된 메모리 공간 중에서 요처오딘 크기와 같은 크기의 메모리 공간이 있다면 이를 그대로 재사용하게 한다. 또한 작은 크기의 할당 요청이 있을 때, 해제된 메모리 공간 중 매우 큰 메모리 공간이 있으면 그 영역을 나누어 주기도 한다.

#### 빠른 메모리 재사용

운영체제가 프로세스에게 제공해 주는 가상 메모리 공간은 매우 넓다. 따라서 특정 메모리 공간을 해제한 이후에 이를 빠르게 재사용하려면 해제된 메모리 공간의 주소를 기억하고 있어야 한다. 이이를 위해 ptmalloc은 메모리 공간을 해제할 때 tcache 또는 bin 이라는 연결 리스트에 해제된 공간의 정보를 저장해 둔다.

tcache 와 bin은 여러 개가 정의되어 있으며, 각각은 서로 다른 크기의 메모리 공간을 저장한다. 이렇게 하면 특정 크기의 할당 요청이 발생했을 때, 그 크기와 관련된 저장소만 탐색하면 되므로 더욱 효율적으로 공간을 재사용할 수 있다.

#### 메모리 단편화 방지

내부 단편화(Internal Fragmentation)
할당한 메모리 공간의 크기에 비해 실제 데이터가 점유하는 공간이 적을 때 발생한다.

외부 단편화(External Fragmentation)
할당한 메모리 공간들 사이에 공간이 많아서 발생하는 비효율을 의미한다.

이를 "단편화" 라고 부르는 이유는 전체 메모리 공간이 여러 데이터들에 의해 부분적으로 점유되기 때문이다.
단편화가 심해질수록, 각 데이터 사이에 공간이 많아져서 메모리 사용의 효율이 감소한다.

ptmalloc은 단편화를 위해 정렬(Alignment)과 병합(Coalescence) 그리고 분할(Split)을 사용한다.
64비트 환경에서 ptmalloc은 메모리 공간을 16바이트 단위로 할당해 준다.

공간을 정렬하지 않고, 프로세스가 요청하는 만큼 할당할 수 있다면 모든 데이터가 연속적으로 할당되어 외부 단편화를 최소화 할 수 있을 것 같다. 하지만 공간을 해제하고 재사용할 때,  정확히 같은 크기의 할당 요청이 발생할 확률보다 비슷한 크기의 요청이 발생할 확률이 높다.
그래서  비슷한 크기의 요청에 대해서는 모두 같은 크기의 공간을 반환해야 해제된 청크들이 재사용률을 높이고, 외부 단편화도 줄일 수 있다.

한편, ptmalloc은 특정 조건을 만족하면 해제된 공간들을 병합하기도 한다.
병합으로 생성된 큰 공간은 그 공간과 같은 크기의 요청에 의해, 또는 그 보다 작은 요청에 의해 분할되어 재사용된다.


